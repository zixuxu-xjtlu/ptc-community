<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTCæ™ºå­¦ç¤¾åŒº (AIåŠ å¼ºç‰ˆ)</title>
    <!-- å¼•å…¥ LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.15.0/dist/av-min.js"></script>
    <!-- å¼•å…¥ Markdown è§£æå™¨ (ä¸ºäº†è®©AIå›ç­”æ›´å¥½çœ‹) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <style>
        /* --- å…¨å±€æ ·å¼ä¿æŒä¸å˜ --- */
        :root { --primary-color: #4a90e2; --bg-color: #f0f2f5; --card-bg: #ffffff; --text-main: #333; --text-secondary: #666; --danger: #ff4d4f; }
        body { font-family: 'Segoe UI', Roboto, sans-serif; margin: 0; background: var(--bg-color); height: 100vh; display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        .btn { cursor: pointer; border: none; border-radius: 4px; padding: 8px 16px; font-weight: bold; transition: 0.3s; }
        .btn-primary { background: var(--primary-color); color: white; }
        .card { background: var(--card-bg); border-radius: 8px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 20px; }
        
        /* å¸ƒå±€ç›¸å…³ */
        #login-page { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .login-box { width: 350px; text-align: center; }
        .login-input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        header { background: var(--card-bg); padding: 0 30px; height: 60px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .container { flex: 1; display: grid; grid-template-columns: 250px 1fr 280px; gap: 20px; padding: 20px; max-width: 1400px; margin: 0 auto; width: 100%; box-sizing: border-box; overflow: hidden; }
        .col-left, .col-right { overflow-y: auto; padding-right: 5px; }
        .col-center { display: flex; flex-direction: column; overflow-y: hidden; }
        
        /* è¾“å…¥åŒºæ ·å¼å‡çº§ */
        .input-area textarea { width: 100%; height: 80px; border: 1px solid #ddd; padding: 10px; resize: none; margin-bottom: 10px; box-sizing: border-box; }
        .file-upload-wrapper { display: inline-block; position: relative; overflow: hidden; margin-right: 10px; }
        .file-upload-wrapper input[type=file] { font-size: 100px; position: absolute; left: 0; top: 0; opacity: 0; cursor: pointer; }
        
        /* å¸–å­æ ·å¼å‡çº§ */
        .qa-scroll-area { flex: 1; overflow-y: auto; padding-right: 5px; }
        .post-image { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 10px; display: block; cursor: pointer; }
        
        /* AI æŒ‰é’®ä¸å›ç­”åŒº */
        .btn-ai { background: linear-gradient(90deg, #6366f1, #8b5cf6); color: white; margin-top: 10px; font-size: 12px; display: flex; align-items: center; gap: 5px;}
        .btn-ai:hover { opacity: 0.9; box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4); }
        
        .ai-response-box {
            background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 6px; 
            padding: 15px; margin-top: 15px; font-size: 14px; line-height: 1.6; color: #334155;
            display: none; /* é»˜è®¤éšè— */
            animation: fadeIn 0.5s;
        }
        .ai-title { font-weight: bold; color: #6366f1; margin-bottom: 5px; display: flex; align-items: center; gap: 5px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }

        /* åŠ è½½åŠ¨ç”» */
        #loading { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 2000; font-weight: bold; color: var(--primary-color); }
        .shop-item { display: flex; align-items: center; margin-bottom: 15px; background: #fafafa; padding: 10px; border-radius: 6px; }
        .ddl-item { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding: 10px 0; }
        .shop-tabs { display: flex; margin-bottom: 15px; border-bottom: 1px solid #eee; }
        .shop-tab { padding: 8px 12px; cursor: pointer; color: #666; } .shop-tab.active { color: var(--primary-color); border-bottom: 2px solid var(--primary-color); }
    </style>
</head>
<body>

    <div id="loading" class="hidden">â˜ï¸ å¤„ç†ä¸­...</div>

    <!-- ç™»å½•ç•Œé¢ -->
    <div id="login-page" class="card">
        <div class="card login-box">
            <h1>ğŸ“ PTCæ™ºå­¦ç¤¾åŒº</h1>
            <input type="text" id="username-input" class="login-input" placeholder="ç”¨æˆ·å">
            <input type="password" id="password-input" class="login-input" placeholder="å¯†ç ">
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-primary" style="flex:1" onclick="doLogin()">ç™» å½•</button>
                <button class="btn" style="flex:1; background:#52c41a; color:white;" onclick="doRegister()">æ³¨ å†Œ</button>
            </div>
        </div>
    </div>

    <!-- ä¸»ç•Œé¢ -->
    <div id="main-page" class="hidden">
        <header>
            <div class="logo">ğŸ“ PTCæ™ºå­¦ç¤¾åŒº <span style="font-size:12px; color:#6366f1; border:1px solid #6366f1; padding:2px 6px; border-radius:4px; margin-left:10px;">AI Powered</span></div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span style="background: #e6f7ff; color: var(--primary-color); padding: 5px 12px; border-radius: 20px; font-weight: bold;">
                    ğŸ’ ç§¯åˆ†: <span id="user-points">--</span>
                </span>
                <span id="display-username" style="font-weight: bold;">ç”¨æˆ·</span>
                <button class="btn" style="background:#eee; font-size:12px;" onclick="doLogout()">é€€å‡º</button>
            </div>
        </header>

        <div class="container">
            <!-- å·¦ä¾§ DDL -->
            <aside class="col-left">
                <div class="card">
                    <h3>ğŸ“… DDL æé†’</h3>
                    <div id="ddl-list"><!-- JSæ¸²æŸ“ --></div>
                </div>
            </aside>

            <!-- ä¸­é—´ï¼šé—®ç­”åŒº -->
            <main class="col-center">
                <div class="card input-area">
                    <textarea id="question-input" placeholder="è¾“å…¥ä½ çš„é—®é¢˜ï¼Œé…å›¾æ›´å®¹æ˜“å¾—åˆ°å›ç­”å“¦..."></textarea>
                    
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <!-- å›¾ç‰‡ä¸Šä¼ æŒ‰é’® -->
                        <div class="file-upload-wrapper">
                            <button class="btn" style="background:#f0f0f0; border:1px solid #ddd;">ğŸ“· ä¸Šä¼ å›¾ç‰‡</button>
                            <input type="file" id="file-input" accept="image/*" onchange="previewImage(this)">
                        </div>
                        <span id="file-name" style="font-size:12px; color:#666; margin-right:auto; margin-left:10px;"></span>

                        <div style="text-align: right;">
                            <span style="font-size: 12px; color: #999; margin-right: 10px;">+5 ç§¯åˆ†</span>
                            <button class="btn btn-primary" onclick="postQuestion()">å‘å¸ƒé—®é¢˜</button>
                        </div>
                    </div>
                </div>

                <div class="qa-scroll-area" id="qa-list">
                    <!-- åŠ¨æ€å†…å®¹ -->
                </div>
            </main>

            <!-- å³ä¾§ï¼šå•†åŸ -->
            <aside class="col-right">
                <div class="card">
                    <h3>ğŸ ç§¯åˆ†å•†åŸ</h3>
                    <div class="shop-tabs">
                        <div class="shop-tab active" onclick="switchTab('midterm')">æœŸä¸­</div>
                        <div class="shop-tab" onclick="switchTab('final')">æœŸæœ«</div>
                        <div class="shop-tab" onclick="switchTab('other')">å‘¨è¾¹</div>
                    </div>
                    <div id="shop-container"><!-- JSæ¸²æŸ“ --></div>
                </div>
            </aside>
        </div>
    </div>

    <script>
        // ----------------------------------------------------
        // é…ç½®åŒº
        // ----------------------------------------------------
        const LEANCLOUD_ID = "VHlIlaHjqetUYuGkN9US6rrP-MdYXbMMI";
        const LEANCLOUD_KEY = "9onESiZ5ikdHZEp8nm4vv58V";
        const LEANCLOUD_SERVER = "https://vhlilahj.api.lncldglobal.com";
        
        // ğŸ¤– DeepSeek API Key (æ³¨æ„å®‰å…¨!)
        const DEEPSEEK_API_KEY = "sk-6dcb9da4bb3a41f9a7f44d6a8fab10f9";

        // ----------------------------------------------------
        // åˆå§‹åŒ–
        // ----------------------------------------------------
        try {
            AV.init({ appId: LEANCLOUD_ID, appKey: LEANCLOUD_KEY, serverURL: LEANCLOUD_SERVER });
        } catch (err) { console.error("SDK Init Error", err); }

        // é™æ€æ•°æ®
        const ddlData = [
            { title: 'EAPæ¼”è®²PPT', time: 'ä»Šå¤© 23:59', urgent: true },
            { title: 'æ•°æ®ç»“æ„å®éªŒ', time: 'æ˜å¤© 12:00', urgent: false }
        ];
        const shopData = {
            midterm: [{ name: 'PTCæ•°å­¦å¤ä¹ ', cost: 30, icon: 'ğŸ“š' }],
            final: [{ name: 'PTCæœŸæœ«å¤ä¹ ', cost: 200, icon: 'ğŸ’' }],
            other: [{ name: 'PTCçŒ«å¤´é¹°', cost: 500, icon: 'ğŸ¦‰' }]
        };

        // UI å·¥å…·
        const ui = {
            loading: (show) => document.getElementById('loading').classList.toggle('hidden', !show),
            showMain: () => {
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('main-page').classList.remove('hidden');
                renderDDL(); renderShop();
            },
            showLogin: () => {
                document.getElementById('login-page').classList.remove('hidden');
                document.getElementById('main-page').classList.add('hidden');
            }
        };

        // ----------------------------------------------------
        // ç”¨æˆ·é€»è¾‘
        // ----------------------------------------------------
        async function doRegister() {
            const u = document.getElementById('username-input').value;
            const p = document.getElementById('password-input').value;
            if(!u||!p) return alert('è¯·è¾“å…¥è´¦å·å¯†ç ');
            ui.loading(true);
            try {
                const user = new AV.User();
                user.setUsername(u); user.setPassword(p); user.set('points', 100);
                await user.signUp();
                initApp();
            } catch(e) { alert(e.message); } finally { ui.loading(false); }
        }

        async function doLogin() {
            const u = document.getElementById('username-input').value;
            const p = document.getElementById('password-input').value;
            ui.loading(true);
            try {
                await AV.User.logIn(u, p);
                initApp();
            } catch(e) { alert(e.message); } finally { ui.loading(false); }
        }

        function doLogout() { AV.User.logOut(); ui.showLogin(); }

        async function initApp() {
            const user = AV.User.current();
            if(!user) return ui.showLogin();
            ui.showMain();
            document.getElementById('display-username').innerText = user.getUsername();
            updatePoints();
            await loadQuestions();
        }

        function updatePoints() {
            const u = AV.User.current();
            document.getElementById('user-points').innerText = u.get('points') || 0;
        }

        // ----------------------------------------------------
        // æ ¸å¿ƒåŠŸèƒ½ï¼šå‘å¸– (å«å›¾ç‰‡)
        // ----------------------------------------------------
        
        // æ–‡ä»¶é€‰æ‹©é¢„è§ˆ
        function previewImage(input) {
            const fileName = input.files[0] ? input.files[0].name : '';
            document.getElementById('file-name').innerText = fileName ? `å·²é€‰: ${fileName}` : '';
        }

        async function postQuestion() {
            const content = document.getElementById('question-input').value;
            const fileInput = document.getElementById('file-input');
            const file = fileInput.files[0];

            if(!content && !file) return alert('è¯·å†™ç‚¹å†…å®¹æˆ–ä¸Šä¼ å›¾ç‰‡');

            ui.loading(true);
            try {
                const Post = AV.Object.extend('Post');
                const post = new Post();
                post.set('content', content);
                post.set('author', AV.User.current());

                // å¦‚æœæœ‰å›¾ç‰‡ï¼Œå…ˆä¸Šä¼ å›¾ç‰‡
                if (file) {
                    const avFile = new AV.File(file.name, file);
                    await avFile.save(); // ä¸Šä¼ åˆ° LeanCloud
                    post.set('image', avFile); // æŠŠå›¾ç‰‡å…³è”åˆ°å¸–å­
                }

                await post.save();
                
                // ç§¯åˆ†+5
                const user = AV.User.current();
                user.increment('points', 5);
                await user.save();

                // é‡ç½®è¾“å…¥æ¡†
                document.getElementById('question-input').value = '';
                fileInput.value = '';
                document.getElementById('file-name').innerText = '';
                
                updatePoints();
                await loadQuestions();
                alert('å‘å¸ƒæˆåŠŸï¼');
            } catch(e) {
                alert('å‘å¸ƒå¤±è´¥: ' + e.message);
            } finally {
                ui.loading(false);
            }
        }

        // ----------------------------------------------------
        // æ ¸å¿ƒåŠŸèƒ½ï¼šåˆ—è¡¨æ¸²æŸ“ + AI è§£ç­”
        // ----------------------------------------------------
        async function loadQuestions() {
            const query = new AV.Query('Post');
            query.descending('createdAt');
            query.include('author');
            try {
                const results = await query.find();
                const container = document.getElementById('qa-list');
                
                container.innerHTML = results.map(post => {
                    const id = post.id;
                    const author = post.get('author') ? post.get('author').getUsername() : 'æœªçŸ¥';
                    const content = post.get('content') || '';
                    const time = post.createdAt.toLocaleString();
                    // å¤„ç†å›¾ç‰‡
                    const imgFile = post.get('image');
                    const imgHtml = imgFile ? `<img src="${imgFile.url()}" class="post-image" onclick="window.open(this.src)">` : '';

                    return `
                    <div class="card" id="card-${id}">
                        <div style="font-size:12px; color:#999; margin-bottom:8px;">ğŸ‘¤ ${author} Â· ${time}</div>
                        <div style="font-size:15px; line-height:1.5;">${content}</div>
                        ${imgHtml}
                        
                        <!-- AI æŒ‰é’® -->
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <button class="btn btn-ai" onclick="askDeepSeek('${id}', \`${content.replace(/`/g, '')}\`)">
                                ğŸ¤– AI å¸®æˆ‘è§£ç­”
                            </button>
                            <!-- AI å›ç­”å®¹å™¨ -->
                            <div id="ai-box-${id}" class="ai-response-box">
                                <div class="ai-title">ğŸ¤– DeepSeek å›ç­”ï¼š</div>
                                <div id="ai-content-${id}">Thinking...</div>
                            </div>
                        </div>
                    </div>`;
                }).join('');
            } catch(e) { console.error(e); }
        }

        // ----------------------------------------------------
        // æ ¸å¿ƒåŠŸèƒ½ï¼šè°ƒç”¨ DeepSeek API
        // ----------------------------------------------------
        async function askDeepSeek(cardId, questionText) {
            const box = document.getElementById(`ai-box-${cardId}`);
            const contentDiv = document.getElementById(`ai-content-${cardId}`);
            
            // æ˜¾ç¤ºå›ç­”æ¡†
            box.style.display = 'block';
            contentDiv.innerHTML = 'ğŸ§  æ­£åœ¨æ€è€ƒä¸­... (DeepSeek V3)';

            try {
                // æ„é€ è¯·æ±‚
                const response = await fetch("https://api.deepseek.com/chat/completions", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${DEEPSEEK_API_KEY}`
                    },
                    body: JSON.stringify({
                        model: "deepseek-chat",
                        messages: [
                            { role: "system", content: "ä½ æ˜¯ä¸€ä¸ªçƒ­å¿ƒçš„å¤§å­¦åŠ©æ•™ï¼Œè¯·ç”¨ç®€æ´ã€é¼“åŠ±çš„è¯­æ°”å›ç­”å­¦ç”Ÿçš„å­¦æœ¯é—®é¢˜ã€‚" },
                            { role: "user", content: questionText }
                        ],
                        stream: false
                    })
                });

                if (!response.ok) {
                    throw new Error(`API é”™è¯¯: ${response.status}`);
                }

                const data = await response.json();
                const answer = data.choices[0].message.content;

                // ä½¿ç”¨ marked.js æ¸²æŸ“ Markdown æ ¼å¼
                contentDiv.innerHTML = marked.parse(answer);

            } catch (error) {
                contentDiv.innerHTML = `<span style="color:red">AI å‘ç”Ÿé”™è¯¯: ${error.message}</span>`;
            }
        }

        // ----------------------------------------------------
        // è¾…åŠ©æ¸²æŸ“
        // ----------------------------------------------------
        function renderDDL() {
            document.getElementById('ddl-list').innerHTML = ddlData.map(i => 
                `<div class="ddl-item"><span>${i.title}</span><span style="color:${i.urgent?'red':'#999'}">${i.time}</span></div>`
            ).join('');
        }
        function renderShop() {
            // ç®€å•å®ç°ï¼Œé»˜è®¤æ˜¾ç¤ºä¸­æœŸ
            document.getElementById('shop-container').innerHTML = shopData['midterm'].map(i => 
                `<div class="shop-item"><div class="shop-item">ğŸ“š</div><div style="flex:1;margin-left:10px;"><b>${i.name}</b><br><small>${i.cost}åˆ†</small></div><button class="btn" style="border:1px solid #4a90e2;color:#4a90e2">å…‘æ¢</button></div>`
            ).join('');
        }

        window.onload = function() {
            if(AV.User.current()) initApp();
        };
    </script>
</body>
</html>